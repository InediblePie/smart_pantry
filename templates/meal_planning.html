{% extends "base.html" %}

{% block content %}
<h2 class="text-center mb-4">Weekly Meal Planner</h2>

<div class="row mb-4">
    <div class="col-md-6">
        <label for="weekSelect" class="form-label">Select Week:</label>
        <input type="text" id="weekSelect" class="form-control" readonly>
        <div id="calendar" class="mt-2"></div>
    </div>
</div>

<form method="POST" action="/save_week">
    <div class="row">
        <div class="col-md-12">
            <div class="card mb-3">
                <div class="card-header">Monday</div>
                <div class="card-body">
                    <input type="text" name="monday" class="form-control mb-2" placeholder="Enter meal">
                    <input type="url" name="monday_recipe" class="form-control mb-2" placeholder="Recipe link (optional)">
                    <label class="form-label">Ingredients:</label>
                    <div id="monday_ingredients_list"></div>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="addIngredient('monday')">+ Add Ingredient</button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card mb-3">
                <div class="card-header">Tuesday</div>
                <div class="card-body">
                    <input type="text" name="tuesday" class="form-control mb-2" placeholder="Enter meal">
                    <input type="url" name="tuesday_recipe" class="form-control mb-2" placeholder="Recipe link (optional)">
                    <label class="form-label">Ingredients:</label>
                    <div id="tuesday_ingredients_list"></div>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="addIngredient('tuesday')">+ Add Ingredient</button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card mb-3">
                <div class="card-header">Wednesday</div>
                <div class="card-body">
                    <input type="text" name="wednesday" class="form-control mb-2" placeholder="Enter meal">
                    <input type="url" name="wednesday_recipe" class="form-control mb-2" placeholder="Recipe link (optional)">
                    <label class="form-label">Ingredients:</label>
                    <div id="wednesday_ingredients_list"></div>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="addIngredient('wednesday')">+ Add Ingredient</button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card mb-3">
                <div class="card-header">Thursday</div>
                <div class="card-body">
                    <input type="text" name="thursday" class="form-control mb-2" placeholder="Enter meal">
                    <input type="url" name="thursday_recipe" class="form-control mb-2" placeholder="Recipe link (optional)">
                    <label class="form-label">Ingredients:</label>
                    <div id="thursday_ingredients_list"></div>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="addIngredient('thursday')">+ Add Ingredient</button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card mb-3">
                <div class="card-header">Friday</div>
                <div class="card-body">
                    <input type="text" name="friday" class="form-control mb-2" placeholder="Enter meal">
                    <input type="url" name="friday_recipe" class="form-control mb-2" placeholder="Recipe link (optional)">
                    <label class="form-label">Ingredients:</label>
                    <div id="friday_ingredients_list"></div>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="addIngredient('friday')">+ Add Ingredient</button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card mb-3">
                <div class="card-header">Saturday</div>
                <div class="card-body">
                    <input type="text" name="saturday" class="form-control mb-2" placeholder="Enter meal">
                    <input type="url" name="saturday_recipe" class="form-control mb-2" placeholder="Recipe link (optional)">
                    <label class="form-label">Ingredients:</label>
                    <div id="saturday_ingredients_list"></div>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="addIngredient('saturday')">+ Add Ingredient</button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card mb-3">
                <div class="card-header">Sunday</div>
                <div class="card-body">
                    <input type="text" name="sunday" class="form-control mb-2" placeholder="Enter meal">
                    <input type="url" name="sunday_recipe" class="form-control mb-2" placeholder="Recipe link (optional)">
                    <label class="form-label">Ingredients:</label>
                    <div id="sunday_ingredients_list"></div>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="addIngredient('sunday')">+ Add Ingredient</button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card mb-3">
                <div class="card-header">Additional Shopping List Items</div>
                <div class="card-body">
                    <label class="form-label">Items:</label>
                    <div id="additional_ingredients_list"></div>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="addIngredient('additional')">+ Add Item</button>
                </div>
            </div>
        </div>
    </div>

    <input type="hidden" name="week" id="weekInput">

    <div class="row mt-4">
        <div class="col-md-6">
            <button type="submit" class="btn btn-primary w-100">Save Week</button>
        </div>
        <div class="col-md-6">
            <button type="button" class="btn btn-success w-100" onclick="downloadShoppingList()">Download Shopping List</button>
        </div>
    </div>
</form>

<script>
    const calendar = document.getElementById('calendar');
    const weekSelect = document.getElementById('weekSelect');
    const weekInput = document.getElementById('weekInput');
    
    function addIngredient(day) {
        const list = document.getElementById(`${day}_ingredients_list`);
        const index = list.children.length;
        const div = document.createElement('div');
        div.className = 'input-group mb-2';
        div.innerHTML = `
            <input type="text" class="form-control ingredient-search" placeholder="Search item name" autocomplete="off" data-day="${day}" data-index="${index}" style="flex: 2;">
            <input type="number" name="${day}_ingredients[]" class="form-control" placeholder="Item ID" readonly style="background-color: #e9ecef; flex: 1;">
            <input type="number" name="${day}_quantities[]" class="form-control" placeholder="Qty" min="1" value="1" style="flex: 0 0 80px;">
            <button type="button" class="btn btn-danger" onclick="removeIngredient(this)">×</button>
        `;
        list.appendChild(div);
        
        const searchInput = div.querySelector('.ingredient-search');
        setupAutocomplete(searchInput, day, index);
    }
    
    function setupAutocomplete(input, day, index) {
        let timeout = null;
        let resultsDiv = null;
        
        input.addEventListener('input', function() {
            clearTimeout(timeout);
            const query = this.value;
            
            if (query.length < 2) {
                if (resultsDiv) resultsDiv.remove();
                return;
            }
            
            timeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/pantry/directory/search?q=${encodeURIComponent(query)}`);
                    const results = await response.json();
                    
                    if (resultsDiv) resultsDiv.remove();
                    
                    if (results.length > 0) {
                        resultsDiv = document.createElement('div');
                        resultsDiv.className = 'list-group position-absolute';
                        resultsDiv.style.zIndex = '1000';
                        resultsDiv.style.maxHeight = '200px';
                        resultsDiv.style.overflowY = 'auto';
                        resultsDiv.style.width = input.offsetWidth + 'px';
                        
                        results.forEach(item => {
                            const resultItem = document.createElement('button');
                            resultItem.type = 'button';
                            resultItem.className = 'list-group-item list-group-item-action';
                            resultItem.textContent = item.name;
                            resultItem.onclick = () => {
                                input.value = item.name;
                                input.nextElementSibling.value = item.id;
                                resultsDiv.remove();
                            };
                            resultsDiv.appendChild(resultItem);
                        });
                        
                        input.parentElement.style.position = 'relative';
                        input.parentElement.appendChild(resultsDiv);
                    }
                } catch (e) {
                    console.error(e);
                }
            }, 300);
        });
        
        input.addEventListener('blur', function() {
            setTimeout(() => {
                if (resultsDiv) resultsDiv.remove();
            }, 200);
        });
    }
    
    function removeIngredient(btn) {
        btn.parentElement.remove();
    }
    
    function getWeekNumber(date) {
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }
    
    function getMonday(d) {
        d = new Date(d);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        return new Date(d.setDate(diff));
    }
    
    function renderCalendar(year, month) {
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startDay = firstDay.getDay();
        
        let html = `<div class="card"><div class="card-body">`;
        html += `<div class="d-flex justify-content-between mb-3">`;
        html += `<button type="button" class="btn btn-sm btn-secondary" onclick="changeMonth(-1)">←</button>`;
        html += `<strong>${firstDay.toLocaleString('default', { month: 'long', year: 'numeric' })}</strong>`;
        html += `<button type="button" class="btn btn-sm btn-secondary" onclick="changeMonth(1)">→</button>`;
        html += `</div>`;
        html += `<table class="table table-bordered table-sm"><thead><tr>`;
        ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
            html += `<th class="text-center">${day}</th>`;
        });
        html += `</tr></thead><tbody><tr>`;
        
        for (let i = 0; i < startDay; i++) {
            html += `<td></td>`;
        }
        
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const monday = getMonday(date);
            const weekNum = getWeekNumber(date);
            const weekStr = `${monday.getFullYear()}-W${String(weekNum).padStart(2, '0')}`;
            
            html += `<td class="text-center" style="cursor:pointer" onclick="selectWeek('${weekStr}', '${monday.toLocaleDateString()}')">${day}</td>`;
            
            if ((startDay + day) % 7 === 0 && day !== daysInMonth) {
                html += `</tr><tr>`;
            }
        }
        
        html += `</tr></tbody></table></div></div>`;
        calendar.innerHTML = html;
    }
    
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth();
    
    function changeMonth(delta) {
        currentMonth += delta;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        } else if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        renderCalendar(currentYear, currentMonth);
    }
    
    function selectWeek(weekStr, mondayStr) {
        weekSelect.value = `Week starting ${mondayStr}`;
        weekInput.value = weekStr;

        fetch(`/get_week_items?week=${weekInput.value}`).then(resp => {
            if (resp.status != 200) {
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                days.forEach(day => {
                    document.querySelector(`input[name="${day}"]`).value = '';
                    document.querySelector(`input[name="${day}_recipe"]`).value = '';
                    document.getElementById(`${day}_ingredients_list`).innerHTML = '';
                });
                document.getElementById('additional_ingredients_list').innerHTML = '';
                return;
            }

            resp.json().then(mealWeekData => {
                console.log(mealWeekData);
                
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                days.forEach(day => {
                    document.querySelector(`input[name="${day}"]`).value = mealWeekData[day] || '';
                    document.querySelector(`input[name="${day}_recipe"]`).value = mealWeekData[`${day}_recipe`] || '';
                    
                    const ingredientsList = document.getElementById(`${day}_ingredients_list`);
                    ingredientsList.innerHTML = '';
                    const ingredients = mealWeekData[`${day}_ingredients`];
                    if (ingredients && Array.isArray(ingredients)) {
                        ingredients.forEach(async (item, index) => {
                            addIngredient(day);
                            const container = ingredientsList.lastElementChild;
                            const idInput = container.querySelector('input[type="number"][name$="_ingredients[]"]');
                            const qtyInput = container.querySelector('input[type="number"][name$="_quantities[]"]');
                            const nameInput = container.querySelector('.ingredient-search');
                            
                            // Handle both old format (string) and new format (object)
                            const itemId = typeof item === 'object' ? item.id : item;
                            const itemQty = typeof item === 'object' ? item.qty : 1;
                            
                            idInput.value = itemId;
                            qtyInput.value = itemQty;
                            
                            // Fetch item name
                            try {
                                const response = await fetch('/pantry/directory/get_item', {
                                    method: 'POST',
                                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                                    body: `item_id=${itemId}`
                                });
                                const data = await response.json();
                                if (data.name) {
                                    nameInput.value = data.name;
                                }
                            } catch (e) {
                                console.error(e);
                            }
                        });
                    }
                });
                
                // Load additional items
                const additionalList = document.getElementById('additional_ingredients_list');
                additionalList.innerHTML = '';
                const additionalItems = mealWeekData['additional_ingredients'];
                if (additionalItems && Array.isArray(additionalItems)) {
                    additionalItems.forEach(async (item, index) => {
                        addIngredient('additional');
                        const container = additionalList.lastElementChild;
                        const idInput = container.querySelector('input[type="number"][name$="_ingredients[]"]');
                        const qtyInput = container.querySelector('input[type="number"][name$="_quantities[]"]');
                        const nameInput = container.querySelector('.ingredient-search');
                        
                        const itemId = typeof item === 'object' ? item.id : item;
                        const itemQty = typeof item === 'object' ? item.qty : 1;
                        
                        idInput.value = itemId;
                        qtyInput.value = itemQty;
                        
                        try {
                            const response = await fetch('/pantry/directory/get_item', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                                body: `item_id=${itemId}`
                            });
                            const data = await response.json();
                            if (data.name) {
                                nameInput.value = data.name;
                            }
                        } catch (e) {
                            console.error(e);
                        }
                    });
                }
            });
        });
    }
    
    function downloadShoppingList() {
        if (!weekInput.value) {
            alert('Please select a week first');
            return;
        }
        window.location.href = `/download_shopping_list?week=${weekInput.value}`;
    }
    
    renderCalendar(currentYear, currentMonth);
</script>
{% endblock %}
